---
import LanguageIcon from "@/icons/languages/LanguageIcon.astro";

const languageRelationships = {
  javascript: {
    related: ["typescript", "json", "html", "css"],
    category: "web-development",
    description: "Core web language",
    contextualReasons: {
      typescript: "Add static types to your JavaScript code",
      json: "Handle data exchange in JavaScript applications",
      html: "Structure content for JavaScript manipulation",
      css: "Style JavaScript-powered web interfaces",
    },
  },
  typescript: {
    related: ["javascript", "json", "html"],
    category: "web-development",
    description: "Typed JavaScript",
    contextualReasons: {
      javascript: "Compile to pure JavaScript for browsers",
      json: "Strongly typed JSON handling and validation",
      html: "Build type-safe frontend applications",
    },
  },
  html: {
    related: ["css", "javascript", "markdown", "xml"],
    category: "web-markup",
    description: "Web markup",
    contextualReasons: {
      css: "Style your HTML with modern CSS",
      javascript: "Add interactivity to HTML pages",
      markdown: "Convert Markdown to HTML for web content",
      xml: "Work with structured markup data",
    },
  },
  css: {
    related: ["scss", "html", "javascript"],
    category: "web-styling",
    description: "Web styling",
    contextualReasons: {
      scss: "Use variables and nesting in CSS",
      html: "Apply styles to HTML elements",
      javascript: "Dynamic CSS manipulation and animations",
    },
  },
  scss: {
    related: ["css", "html"],
    category: "web-styling",
    description: "CSS preprocessor",
    contextualReasons: {
      css: "Compile SCSS to standard CSS",
      html: "Style HTML with advanced CSS features",
    },
  },
  json: {
    related: ["yaml", "xml", "javascript", "typescript"],
    category: "data-format",
    description: "Data exchange format",
    contextualReasons: {
      yaml: "Convert between JSON and YAML configurations",
      xml: "Transform JSON to XML for legacy systems",
      javascript: "Parse and generate JSON in JavaScript apps",
      typescript: "Type-safe JSON handling in TypeScript",
    },
  },
  yaml: {
    related: ["json", "xml"],
    category: "data-format",
    description: "Configuration format",
    contextualReasons: {
      json: "Convert YAML to JSON for APIs",
      xml: "Transform configuration to XML format",
    },
  },
  xml: {
    related: ["json", "html"],
    category: "data-format",
    description: "Markup language",
    contextualReasons: {
      json: "Convert XML data to JSON format",
      html: "Transform XML into HTML for display",
    },
  },
  python: {
    related: ["python/ruff", "json", "yaml"],
    category: "programming",
    description: "General purpose",
    contextualReasons: {
      "python/ruff": "Fast Python linting and formatting",
      json: "Handle JSON data in Python applications",
      yaml: "Parse YAML configuration files",
    },
  },
  "python/ruff": {
    related: ["python", "json"],
    category: "programming",
    description: "Fast Python formatter",
    contextualReasons: {
      python: "Standard Python formatting with Ruff",
      json: "Format JSON handling in Python code",
    },
  },
  go: {
    related: ["c", "cpp", "json"],
    category: "programming",
    description: "Systems programming",
    contextualReasons: {
      c: "Interoperate with C libraries in Go",
      cpp: "Compare with C++ for systems programming",
      json: "JSON marshaling/unmarshaling in Go",
    },
  },
  c: {
    related: ["cpp", "csharp", "go"],
    category: "programming",
    description: "Systems programming",
    contextualReasons: {
      cpp: "Add object-oriented features to C code",
      csharp: "Compare C with C# syntax",
      go: "Compare C performance with Go",
    },
  },
  cpp: {
    related: ["c", "csharp", "go"],
    category: "programming",
    description: "Systems programming",
    contextualReasons: {
      c: "Low-level C interoperability",
      csharp: "Compare C++ with C# features",
      go: "Compare C++ performance with Go",
    },
  },
  csharp: {
    related: ["c", "cpp", "json"],
    category: "programming",
    description: "Microsoft language",
    contextualReasons: {
      c: "Understand C# syntax compared to C",
      cpp: "Compare features between C# and C++",
      json: "JSON serialization in .NET",
    },
  },
  java: {
    related: ["json", "xml"],
    category: "programming",
    description: "Enterprise development",
    contextualReasons: {
      json: "JSON processing in Java applications",
      xml: "XML parsing and generation in Java",
    },
  },
  php: {
    related: ["php/mago", "json", "html", "xml"],
    category: "web-development",
    description: "Web backend",
    contextualReasons: {
      "php/mago": "Modern PHP formatting with Mago",
      json: "API development with JSON in PHP",
      html: "Generate HTML content in PHP",
      xml: "Process XML data in PHP applications",
    },
  },
  "php/mago": {
    related: ["php", "json"],
    category: "web-development",
    description: "PHP formatter",
    contextualReasons: {
      php: "Format standard PHP code with Mago",
      json: "Format JSON handling in PHP code",
    },
  },
  rust: {
    related: ["c", "cpp", "go"],
    category: "programming",
    description: "Systems programming",
    contextualReasons: {
      c: "Rust vs C: memory safety comparison",
      cpp: "Rust vs C++: modern systems programming",
      go: "Compare Rust and Go performance",
    },
  },
  sql: {
    related: ["json", "yaml"],
    category: "data-format",
    description: "Database queries",
    contextualReasons: {
      json: "Export query results as JSON",
      yaml: "Store database configurations in YAML",
    },
  },
  dart: {
    related: ["json", "yaml"],
    category: "programming",
    description: "Flutter language",
    contextualReasons: {
      json: "Parse JSON in Flutter applications",
      yaml: "Read YAML configurations in Dart",
    },
  },
  lua: {
    related: ["json", "yaml"],
    category: "programming",
    description: "Scripting language",
    contextualReasons: {
      json: "JSON processing in Lua scripts",
      yaml: "Parse YAML configuration files",
    },
  },
  markdown: {
    related: ["html", "xml"],
    category: "documentation",
    description: "Documentation format",
    contextualReasons: {
      html: "Convert Markdown to HTML for web",
      xml: "Transform Markdown to XML structure",
    },
  },
  proto: {
    related: ["json", "yaml"],
    category: "data-format",
    description: "Protocol buffers",
    contextualReasons: {
      json: "Convert Protocol Buffers to JSON",
      yaml: "Format proto configurations in YAML",
    },
  },
  zig: {
    related: ["c", "cpp", "go"],
    category: "programming",
    description: "Systems programming",
    contextualReasons: {
      c: "Zig vs C: modern systems language",
      cpp: "Compare Zig with C++ performance",
      go: "Zig vs Go: compile-time features",
    },
  },
};

const allTools = [
  { name: "HTML", url: "/html", type: "FMT" },
  { name: "CSS", url: "/css", type: "FMT" },
  { name: "JavaScript", url: "/javascript", type: "FMT" },
  { name: "JavaScript Biome", url: "/javascript/biome", type: "FMT" },
  { name: "TypeScript", url: "/typescript", type: "FMT" },
  { name: "TypeScript Biome", url: "/typescript/biome", type: "FMT" },
  { name: "JSON", url: "/json", type: "FMT" },
  { name: "XML", url: "/xml", type: "FMT" },
  { name: "YAML", url: "/yaml", type: "FMT" },
  { name: "SQL", url: "/sql", type: "FMT" },
  { name: "Go", url: "/go", type: "FMT" },
  { name: "Dart", url: "/dart", type: "FMT" },
  { name: "SCSS", url: "/scss", type: "FMT" },
  { name: "Java", url: "/java", type: "FMT" },
  { name: "Lua", url: "/lua", type: "FMT" },
  { name: "Python", url: "/python", type: "FMT" },
  { name: "Python Ruff", url: "/python/ruff", type: "FMT" },
  { name: "Markdown", url: "/markdown", type: "FMT" },
  { name: "C#", url: "/csharp", type: "FMT" },
  { name: "C", url: "/c", type: "FMT" },
  { name: "C++", url: "/cpp", type: "FMT" },
  { name: "PHP", url: "/php", type: "FMT" },
  { name: "PHP Mago", url: "/php/mago", type: "FMT" },
  { name: "Proto", url: "/proto", type: "FMT" },
  { name: "Zig", url: "/zig", type: "FMT" },
];

type Props = {
  currentLanguage?: string;
  minify?: boolean;
};

const { currentLanguage, minify = false } = Astro.props;

const getRelatedTools = () => {
  if (!currentLanguage || !languageRelationships[currentLanguage]) {
    return [
      {
        name: "JSON",
        url: "/json",
        type: "FMT",
        reason: "Most Popular",
        description: "Handle data exchange with JSON formatting",
      },
      {
        name: "JavaScript",
        url: "/javascript",
        type: "FMT",
        reason: "Web Development",
        description: "Format JavaScript for web applications",
      },
      {
        name: "Python",
        url: "/python",
        type: "FMT",
        reason: "Popular Choice",
        description: "Clean Python code with PEP 8 formatting",
      },
      {
        name: "TypeScript",
        url: "/typescript",
        type: "FMT",
        reason: "Type Safe JS",
        description: "Add static types to your JavaScript",
      },
    ];
  }

  const relationship = languageRelationships[currentLanguage];
  const relatedTools = relationship.related
    .map(lang => {
      const tool = allTools.find(t => t.url === `/${lang}`);
      if (tool) {
        const contextualReason = relationship.contextualReasons
          ?.[lang.replace("python/", "python/ruff")];
        return {
          ...tool,
          reason: contextualReason || relationship.description,
          description: contextualReason || relationship.description,
        };
      }
      return null;
    })
    .filter(Boolean)
    .slice(0, 6);

  return relatedTools.length >= 3 ? relatedTools : [
    {
      name: "JSON",
      url: "/json",
      type: "FMT",
      reason: "Data Format",
      description: "Standard data exchange format",
    },
    {
      name: "JavaScript",
      url: "/javascript",
      type: "FMT",
      reason: "Web Development",
      description: "Essential for web development",
    },
    {
      name: "Python",
      url: "/python",
      type: "FMT",
      reason: "Popular Choice",
      description: "Versatile and widely-used language",
    },
  ];
};

const relatedTools = getRelatedTools();
const showSection = currentLanguage && relatedTools.length > 0;
---

{showSection && (
  <section
    class="py-8 px-4 bg-gradient-to-br from-zinc-50 to-zinc-100 dark:from-zinc-900 dark:to-zinc-800 border-y border-zinc-200 dark:border-zinc-700"
    aria-labelledby="related-tools-heading"
  >
    <div class="container mx-auto max-w-4xl">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2
            id="related-tools-heading"
            class="text-2xl font-bold font-display text-foreground mb-2"
          >
            Related Tools
          </h2>
          <p class="text-muted-foreground">
            Frequently used together with
            {currentLanguage.charAt(0).toUpperCase() + currentLanguage.slice(1)}
            {minify ? "Minifier" : "Formatter"}
          </p>
        </div>
        <div class="hidden md:flex items-center gap-2 text-sm text-muted-foreground">
          <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
          <span>Contextual suggestions</span>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {relatedTools.map((tool) => {
          const isCurrentLanguage = tool.url === `/${currentLanguage}`;
          const actionUrl = minify && isCurrentLanguage
            ? tool.url
            : `${tool.url}${minify ? "/minify" : ""}`;

          return (
            <a
              href={actionUrl}
              class="group bg-white dark:bg-zinc-800 border border-zinc-200 dark:border-zinc-700 rounded-lg p-4 hover:border-primary hover:shadow-lg transition-all duration-200 flex items-start gap-4"
            >
              <div class="flex-shrink-0">
                <div class="w-12 h-12 bg-primary/10 rounded-lg flex items-center justify-center group-hover:bg-primary/20 transition-colors">
                  <LanguageIcon
                    icon={tool.url.replace(/\//g, "-")}
                    class="w-6 h-6"
                  />
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-semibold text-foreground group-hover:text-primary transition-colors">
                    {tool.name}
                  </h3>
                  <span
                    class="text-xs font-mono bg-primary/10 text-primary px-2 py-0.5 rounded"
                  >
                    {tool.type}
                  </span>
                  {isCurrentLanguage && (
                    <span
                      class="text-xs font-mono bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400 px-2 py-0.5 rounded"
                    >
                      {minify ? "Format" : "Minify"}
                    </span>
                  )}
                </div>

                <p class="text-sm text-muted-foreground mb-1">
                  {tool.reason}
                </p>
                {tool.description && tool.description !== tool.reason && (
                  <p class="text-xs text-muted-foreground mb-2 leading-relaxed">
                    {tool.description}
                  </p>
                )}

                <div class="flex items-center gap-2 text-xs text-zinc-500">
                  <span
                    class="opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    {isCurrentLanguage
                      ? (minify ? "Switch to formatter" : "Switch to minifier")
                      : "Open tool"}
                  </span>
                  <span
                    class="group-hover:translate-x-1 transition-transform inline-block"
                  >→</span>
                </div>
              </div>
            </a>
          );
        })}
      </div>

      <div class="mt-6 text-center">
        <a
          href="/#more-tools"
          class="inline-flex items-center gap-2 text-sm text-primary hover:text-primary/80 transition-colors"
        >
          <span>View all {allTools.length} available tools</span>
          <span
            class="group-hover:translate-x-1 transition-transform inline-block"
          >→</span>
        </a>
      </div>
    </div>
  </section>
)}
