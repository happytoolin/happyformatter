---
import Reload from "@/icons/reload.astro";
import { shikiThemes } from "./themes";

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<RootElement>
  <div class:list={["theme-selector-wrapper flex items-center gap-1.5", className]}>
    <button
      id="theme-reload-btn"
      data-target="theme-reload-btn"
      class="hidden h-7 items-center justify-center rounded-md px-2 text-[10px] font-medium text-amber-500 bg-amber-500/10 border border-amber-500/20 hover:bg-amber-500/20 transition-all animate-in fade-in slide-in-from-right-4 duration-300"
      title="Reload page to apply theme changes completely"
      aria-label="Reload page"
    >
      <Reload class="w-3 h-3 mr-1.5" />
      Reload
    </button>
    <div class:list={["theme-selector relative flex-1 min-w-[120px]", className]}>
      <div class="relative">
        <select
          aria-label="Theme selector"
          id="theme-select"
          data-target="theme-select"
          class="w-full appearance-none h-7 rounded-md bg-muted/40 border border-transparent hover:border-border hover:bg-muted/60 pl-2.5 pr-7 py-0 text-xs font-medium text-muted-foreground focus:text-foreground transition-all focus:outline-hidden focus:ring-2 focus:ring-ring/20 cursor-pointer"
        >
          <option value="" disabled selected>Theme</option>
          {shikiThemes.map((theme) => (
            <option value={theme.value}>{theme.name}</option>
          ))}
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-muted-foreground/50">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="12"
            height="12"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-chevron-down"
          >
            <path d="m6 9 6 6 6-6" />
          </svg>
        </div>
      </div>
    </div>
  </div>
</RootElement>

<script>
RootElement.ready(($) => {
  const selectElement = $("theme-select") as HTMLSelectElement;
  const reloadButton = $("theme-reload-btn") as HTMLButtonElement;
  let initialTheme = document.documentElement.getAttribute("data-theme");

  // Load the saved theme from localStorage
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    selectElement.value = savedTheme;
    document.documentElement.setAttribute("data-theme", savedTheme);
    initialTheme = savedTheme;
  }

  selectElement.addEventListener("change", () => {
    const selectedTheme = selectElement.value;

    if (selectedTheme) {
      document.documentElement.setAttribute("data-theme", selectedTheme);
      localStorage.setItem("theme", selectedTheme);

      // Show reload button if theme changed
      if (selectedTheme !== initialTheme) {
        reloadButton.classList.remove("hidden");
        reloadButton.classList.add("flex");
      }
    }
  });

  // Reload button click handler
  reloadButton.addEventListener("click", () => {
    window.location.reload();
  });

  // Add observer to detect external theme changes
  const observer = new MutationObserver(() => {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    localStorage.setItem("theme", currentTheme || "default");
    if (currentTheme) {
      selectElement.value = currentTheme;

      // Show reload button if theme changed from initial
      if (currentTheme !== initialTheme) {
        reloadButton.classList.remove("hidden");
        reloadButton.classList.add("flex");
      } else {
        reloadButton.classList.add("hidden");
        reloadButton.classList.remove("flex");
      }
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["data-theme"],
  });
});
</script>
