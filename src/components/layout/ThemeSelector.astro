---
import { shikiThemes } from "./themes";

interface Props {
  class?: string;
}

const { class: className } = Astro.props;
---

<RootElement>
  <div class:list={["theme-selector relative", className]}>
    <select
      aria-label="Theme selector"
      id="theme-select"
      data-target="theme-select"
      class="w-full h-9 rounded-md border border-input bg-transparent px-3 py-1 text-xs shadow-xs transition-colors file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-hidden focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50"
    >
      <option value="" disabled selected>Theme</option>
      {shikiThemes.map((theme) => (
        <option value={theme.value}>{theme.name}</option>
      ))}
    </select>
  </div>
</RootElement>

<script>
RootElement.ready(($) => {
  const selectElement = $("theme-select") as HTMLSelectElement;

  // Load the saved theme from localStorage
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    selectElement.value = savedTheme;
    document.documentElement.setAttribute("data-theme", savedTheme);
  }

  selectElement.addEventListener("change", () => {
    const selectedTheme = selectElement.value;

    if (selectedTheme) {
      document.documentElement.setAttribute("data-theme", selectedTheme);
      localStorage.setItem("theme", selectedTheme);
    }
  });

  // Add observer
  const observer = new MutationObserver(() => {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    localStorage.setItem("theme", currentTheme || "default");
    if (currentTheme) {
      selectElement.value = currentTheme;
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["data-theme"],
  });
});
</script>
