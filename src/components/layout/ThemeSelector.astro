---
import { themes } from "./themes";
---
<RootElement>
  <div class="theme-selector relative w-[180px]">
    <select
      id="theme-select"
      data-target="theme-select"
      class="w-full h-10 rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
    >
      <option value="" disabled selected>Select theme</option>
      {themes.map((theme) => <option value={theme.value}>{theme.name}</option>)}
    </select>
  </div>
</RootElement>

<script is:inline>
const getInitialTheme = () => {
  if (typeof localStorage !== "undefined" && localStorage.getItem("theme")) {
    return localStorage.getItem("theme");
  }
  return "rose-pine";
};
const theme = getInitialTheme();
document.documentElement.setAttribute("data-theme", theme);
</script>

<script>
RootElement.ready(($) => {
  const selectElement = $("theme-select") as HTMLSelectElement;

  // Load the saved theme from localStorage
  const savedTheme = localStorage.getItem("theme");
  if (savedTheme) {
    selectElement.value = savedTheme;
    document.documentElement.setAttribute("data-theme", savedTheme);
  }

  selectElement.addEventListener("change", () => {
    const selectedTheme = selectElement.value;

    if (selectedTheme) {
      document.documentElement.setAttribute("data-theme", selectedTheme);
      localStorage.setItem("theme", selectedTheme);
    }
  });

  // Add observer
  const observer = new MutationObserver(() => {
    const currentTheme = document.documentElement.getAttribute("data-theme");
    localStorage.setItem("theme", currentTheme || "default");
    if (currentTheme) {
      selectElement.value = currentTheme;
    }
  });

  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ["data-theme"],
  });
});
</script>
