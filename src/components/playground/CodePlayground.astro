---
import { highlightCode, initializeHighlighter } from "@/lib/highlighter";
import { scope } from "simple:scope";
import Textarea from "../ui/textarea.astro";
import { formattedStore, inputStore } from "./store";
import { getInitialCode } from "@/lib/initialCode";

interface Props {
  inputCode: string;
  language: string;
  theme: string;
}

const { inputCode, language, theme } = Astro.props;

const initialCode = getInitialCode(language);
inputStore.set(initialCode);
formattedStore.set(initialCode);

const input = inputStore.get();

const InitialCodeHTMLString = async () => {
  const highlighter = await initializeHighlighter(language, theme);
  return highlightCode(input, highlighter, language, theme);
};

const highlightedHTML = await InitialCodeHTMLString();
---

<RootElement>
  <div
    class="transition-none"
    style="color-scheme: inherit;"
    data-target="root"
    data-language={language}
  >
    <div class="relative mt-10 min-h-[400px] max-h-[600px] overflow-auto">
      <div
        class="block max-h-[600px] overflow-auto min-h-[400px]"
        data-target="highlight"
        id="highlight_code"
        set:html={highlightedHTML}
      />
      <Textarea
        id="codeTextarea"
        class="whitespace-pre overflow-auto w-full h-full font-mono bg-transparent absolute inset-0 py-5 px-6 text-transparent caret-gray-600 tab-4 resize-none z-10 max-h-[600px] min-h-[400px]"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        data-initial={inputCode}
        target={scope("textarea")}
      />
    </div>
  </div>
</RootElement>

<script>
  import { highlightCode, initializeHighlighter } from "@/lib/highlighter";
  import { getInitialCode } from "@/lib/initialCode";
  import { throttle } from "@/lib/throttle";
  import type { Highlighter } from "shiki";
  import { inputStore } from "./store";

  function syncScroll(
    preElement: HTMLElement,
    textArea: HTMLTextAreaElement
  ): void {
    preElement.scrollTop = textArea.scrollTop;
    preElement.scrollLeft = textArea.scrollLeft;
  }

  function handleInputEvent(
    e: Event,
    highlighter: Highlighter,
    highlightDiv: HTMLDivElement,
    throttledHighlight: (code: string) => void,
    language: string,
    theme: string
  ): void {
    const element = e.target as HTMLTextAreaElement;
    const code = element.value;

    if (code) {
      inputStore.set(code);
      const immediateHighlightedCode = highlightCode(
        code,
        highlighter,
        language,
        theme
      );
      highlightDiv.innerHTML = immediateHighlightedCode;

      throttledHighlight(code);
    }

    // try {
    //   JSON.parse(code);
    //   if (!jsonValidStore.get()) {
    //     jsonValidStore.set(true);
    //   } else {
    //     jsonValidStore.notify();
    //   }
    // } catch (error) {
    //   jsonValidStore.set(false);
    // }
  }

  function setupEventListeners(
    textArea: HTMLTextAreaElement,
    highlightDiv: HTMLDivElement,
    highlighter: Highlighter,
    language: string,
    theme: string
  ): void {
    const throttledHighlight = throttle((code: string) => {
      const highlightedCode = highlightCode(code, highlighter, language, theme);
      highlightDiv.innerHTML = highlightedCode;

      const preElement = highlightDiv.querySelector("pre");

      if (!preElement) {
        console.error("No pre element found");
        return;
      }

      textArea.addEventListener("scroll", () =>
        syncScroll(preElement, textArea)
      );
    }, 300);

    textArea.addEventListener("input", (e) =>
      handleInputEvent(
        e,
        highlighter,
        highlightDiv,
        throttledHighlight,
        language,
        theme
      )
    );

    textArea.addEventListener("paste", (e) => {
      handleInputEvent(
        e,
        highlighter,
        highlightDiv,
        throttledHighlight,
        language,
        theme
      );
    });

    textArea.addEventListener("scroll", () =>
      syncScroll(highlightDiv, textArea)
    );
  }

  RootElement.ready(async ($) => {
    const highlightDiv = $("highlight") as HTMLDivElement;
    const textArea = $("textarea") as HTMLTextAreaElement;
    const divLanguage = $("root") as HTMLDivElement;

    const language = divLanguage.dataset.language as string;

    let initialCode = textArea.dataset.initial;

    const theme = "everforest-light" as string;

    if (!initialCode) {
      initialCode = getInitialCode(language);
      inputStore.set(initialCode);
    }

    textArea.value = initialCode;

    try {
      const highlighter = await initializeHighlighter(language, theme);

      setupEventListeners(textArea, highlightDiv, highlighter, language, theme);
    } catch (error) {
      console.error("Initialization failed:", error);
    }
  });
</script>
