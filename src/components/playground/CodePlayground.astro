---
import { highlightCode, initializeHighlighter } from "@/lib/highlighter";
import { getInitialCode } from "@/lib/initialCode";
import { scope } from "simple:scope";
import Textarea from "../ui/textarea.astro";
import { inputStore, resetStores } from "./store";

interface Props {
  inputCode: string;
  language: string;
}

const { inputCode, language } = Astro.props;

// Initialize formatting for initial render
const InitialCodeHTMLString = async () => {
  try {
    const highlighter = await initializeHighlighter(language);
    return highlightCode(inputCode, highlighter, language);
  } catch (e) {
    return `<pre><code>${inputCode}</code></pre>`;
  }
};

const highlightedHTML = await InitialCodeHTMLString();

// Note: We do NOT reset stores here to allow persistence across navigations if desired,
// or we can strictly reset. For now, we trust the parent props.
---

<RootElement>
  <div
    class="relative w-full h-full overflow-hidden bg-white dark:bg-zinc-900"
    data-target="root"
    data-language={language}
  >
    <!-- Grid Background for the Editor -->
    <div
      class="absolute inset-0 pointer-events-none opacity-[0.03] z-0"
      style="background-image:
  linear-gradient(#000 1px, transparent 1px),
  linear-gradient(90deg, #000 1px, transparent 1px); background-size: 20px 20px"
    >
    </div>

    <!-- Scroll Container -->
    <div class="relative w-full h-full overflow-auto scrollbar-industrial">
      <!-- The Editor Stack: Textarea on top of Highlighter -->
      <div class="relative min-h-full">
        <!-- The Syntax Highlight Layer (Bottom) -->
        <div
          class="pointer-events-none absolute inset-0 p-6 z-10 font-mono text-sm leading-relaxed"
          data-target="highlight"
          id="highlight_code"
          set:html={highlightedHTML}
        />

        <!-- The Input Layer (Top, Transparent) -->
        <Textarea
          aria-label="Code Editor"
          id="codeTextarea"
          class="absolute inset-0 w-full h-full p-6 z-20 font-mono text-sm leading-relaxed bg-transparent text-transparent caret-primary resize-none outline-none focus:ring-0 border-0"
          spellcheck="false"
          data-initial={inputCode}
          value={inputCode}
          target={scope("textarea")}
        />
      </div>
    </div>
  </div>
</RootElement>

<script>
import { highlightCode, initializeHighlighter } from "@/lib/highlighter";
import { throttle } from "@/lib/throttle";
import { inputStore } from "./store";

RootElement.ready(async ($) => {
  const highlightDiv = $("highlight") as HTMLDivElement;
  const textArea = $("textarea") as HTMLTextAreaElement;
  const divLanguage = $("root") as HTMLDivElement;
  const language = divLanguage.dataset.language as string;

  // Sync Input Store to Textarea
  inputStore.subscribe(newCode => {
    if (newCode !== textArea.value) {
      textArea.value = newCode;
      // Trigger highlight update
      updateHighlight(newCode);
    }
  });

  // Highlighter Instance
  const highlighter = await initializeHighlighter(language);

  const updateHighlight = (code: string) => {
    const highlighted = highlightCode(code, highlighter, language);
    highlightDiv.innerHTML = highlighted;

    // Ensure colors match theme (using helper classes or computed styles)
    // The global CSS handles .shiki text colors, we just need to ensure the transparent textarea aligns
  };

  const throttledUpdate = throttle(updateHighlight, 50);

  textArea.addEventListener("input", () => {
    const code = textArea.value;
    inputStore.set(code);
    throttledUpdate(code);
  });

  // Handle Tab Key for Indentation
  textArea.addEventListener("keydown", function(e) {
    if (e.key == "Tab") {
      e.preventDefault();
      var start = this.selectionStart;
      var end = this.selectionEnd;
      // set textarea value to: text before caret + tab + text after caret
      this.value = this.value.substring(0, start)
        + "    " + this.value.substring(end);
      // put caret at right position again
      this.selectionStart = this.selectionEnd = start + 4;
      // Update highlight
      inputStore.set(this.value);
      throttledUpdate(this.value);
    }
  });
});
</script>

<style>
/* Ensure textarea text is invisible but caret remains */
#codeTextarea {
  color: transparent;
  background: transparent;
}
#codeTextarea::selection {
  background: rgba(255, 102, 0, 0.3); /* Brand Orange Selection */
  color: transparent;
}
</style>
