---
const { language } = Astro.props;
---

<div id="code-validity-indicator" class="flex items-center">
  <span
    class="font-mono text-[10px] font-bold uppercase flex items-center gap-2 px-2 py-1 bg-muted border border-border"
  >
    STATUS: <span id="status-text">CHECKING...</span>
    <span id="status-dot" class="w-2 h-2 rounded-full bg-gray-400"></span>
  </span>
</div>

<script>
import { getFormatter } from "@/handlers";
import { inputStore } from "./store";

const statusText = document.getElementById("status-text");
const statusDot = document.getElementById("status-dot");
const languageElement = document.querySelector("[data-language]");
// @ts-ignore
const language = languageElement?.dataset.language;

async function checkCodeValidity() {
  if (!language || !statusText || !statusDot) return;

  const formatter = await getFormatter(language);
  const inputCode = inputStore.get();

  if (!inputCode || inputCode.trim() === "") {
    statusText.innerText = "IDLE";
    statusText.classList.remove("text-green-600", "text-red-600");
    statusDot.className = "w-2 h-2 rounded-full bg-gray-400";
    return;
  }

  if (formatter && typeof formatter.validateCode === "function") {
    try {
      const isValid = await formatter.validateCode(inputCode);
      if (isValid) {
        statusText.innerText = "VALID SYNTAX";
        statusText.classList.add("text-green-600");
        statusDot.className =
          "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(0,255,0,0.8)]";
      } else {
        statusText.innerText = "SYNTAX ERROR";
        statusText.classList.add("text-red-600");
        statusDot.className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
      }
    } catch (error) {
      // handle error
    }
  } else {
    statusText.innerText = "READY";
    statusDot.className = "w-2 h-2 rounded-full bg-primary";
  }
}

// Debounce check
let timeout: any;
inputStore.subscribe(() => {
  clearTimeout(timeout);
  timeout = setTimeout(checkCodeValidity, 500);
});
</script>
