---
import { getFormatter } from "@/handlers";
import Copy from "@/icons/copy.astro";
import Format from "@/icons/format.astro";
import Minify from "@/icons/minify.astro";
import { getInitialCode } from "@/lib/initialCode";
import { scope } from "simple:scope";
import Button from "../ui/button.astro";
import CodePlayground from "./CodePlayground.astro";
import CodeValid from "./CodeValid.astro";
import { formattedStore, inputStore } from "./store";

interface Props {
  minifier: boolean;
  language: string;
}

const { language, minifier } = Astro.props;

// Initialize Store Server-Side to prevent flash
const input = inputStore.get();
if (!input) {
  const initialCode = getInitialCode(language);
  inputStore.set(initialCode);
}
---

<RootElement>
  <div
    class="w-full bg-background py-12"
    data-language={language}
    data-target="root"
    id="formatter"
  >
    <div class="container mx-auto max-w-6xl">
      <!-- The Machine Housing -->
      <div class="relative border-2 border-foreground bg-card shadow-[8px_8px_0px_0px_var(--color-foreground)]">
        <!-- Machine Header / Toolbar -->
        <div class="flex flex-col md:flex-row items-start md:items-center justify-between border-b-2 border-foreground bg-secondary p-4 gap-4">
          <div class="flex items-center gap-4">
            <div class="flex gap-1">
              <div class="w-3 h-3 rounded-full border border-foreground bg-background">
              </div>
              <div class="w-3 h-3 rounded-full border border-foreground bg-background">
              </div>
            </div>
            <div class="font-mono text-xs font-bold uppercase tracking-widest text-muted-foreground">
              Editor // {language.toUpperCase()}
            </div>
          </div>

          <div class="flex items-center gap-2 w-full md:w-auto">
            <CodeValid language={language} />
          </div>
        </div>

        <!-- The Single Editor Pane -->
        <div class="relative h-[600px] w-full bg-background group">
          <!-- Flash Overlay for Effect -->
          <div
            id="flash-overlay"
            class="absolute inset-0 bg-primary opacity-0 pointer-events-none z-50 transition-opacity duration-300"
          >
          </div>

          <CodePlayground
            inputCode={inputStore.get() || getInitialCode(language)}
            language={language}
          />
        </div>

        <!-- Control Deck -->
        <div class="border-t-2 border-foreground p-4 bg-background grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
          <div class="text-[10px] font-mono text-muted-foreground hidden md:block">
            READY TO PROCESS. <br /> PRESS ACTION TO EXECUTE.
          </div>

          <div class="flex flex-col md:flex-row gap-3 justify-end">
            {minifier && (
              <Button
                variant="outline"
                size="lg"
                target={scope("minify")}
                class="w-full md:w-auto"
              >
                <Minify class="w-4 h-4 mr-2" /> MINIFY
              </Button>
            )}

            <Button
              variant="default"
              size="lg"
              target={scope("format")}
              class="w-full md:w-auto bg-primary hover:bg-primary/90 text-black border-2 border-black"
            >
              <Format class="w-4 h-4 mr-2" /> FORMAT CODE
            </Button>

            <Button
              variant="ghost"
              size="icon"
              target={scope("copy")}
              class="border-2 border-transparent hover:border-foreground"
              title="Copy to Clipboard"
            >
              <Copy class="w-5 h-5" />
            </Button>
          </div>
        </div>
      </div>

      <!-- Decorative Footer for the Machine -->
      <div class="mt-2 flex justify-between font-mono text-[10px] text-muted-foreground uppercase">
        <span>REF: {language.toUpperCase()}-FMT-001</span>
        <span>LATENCY: 0ms (LOCAL)</span>
      </div>
    </div>
  </div>
</RootElement>

<script>
import { getFormatter, getMinifier } from "@/handlers";
import { getInitialCode } from "@/lib/initialCode";
import { formattedStore, inputStore } from "./store";

RootElement.ready(async ($) => {
  const divElement = $("root");
  const language = divElement.dataset.language!;
  const flashOverlay = document.getElementById("flash-overlay");

  const formatter = await getFormatter(language);
  const minifier = await getMinifier(language);

  // Helper to trigger flash
  const triggerFlash = () => {
    if (flashOverlay) {
      flashOverlay.style.opacity = "0.3";
      setTimeout(() => flashOverlay.style.opacity = "0", 150);
    }
  };

  // Helper for button text feedback
  const showFeedback = (
    btn: HTMLButtonElement,
    originalHtml: string,
    tempText: string,
  ) => {
    btn.innerHTML = `<span class="font-bold">${tempText}</span>`;
    setTimeout(() => {
      btn.innerHTML = originalHtml;
    }, 1500);
  };

  const formatButton = $("format") as HTMLButtonElement;
  const formatOriginal = formatButton.innerHTML;

  formatButton.addEventListener("click", async () => {
    let inputCode = inputStore.get();
    if (!inputCode) {
      inputCode = getInitialCode(language);
      inputStore.set(inputCode);
    }

    try {
      formatButton.disabled = true;
      formatButton.innerText = "PROCESSING...";

      const result = await formatter.formatCode(inputCode);

      // Update the input store directly to replace text
      triggerFlash();
      inputStore.set(result);

      showFeedback(formatButton, formatOriginal, "DONE");
    } catch (error) {
      console.error("Format Error:", error);
      showFeedback(formatButton, formatOriginal, "ERROR");
    } finally {
      formatButton.disabled = false;
    }
  });

  if (minifier) {
    const minifyButton = $("minify") as HTMLButtonElement;
    const minifyOriginal = minifyButton.innerHTML;

    minifyButton.addEventListener("click", async () => {
      let inputCode = inputStore.get();
      if (!inputCode) {
        inputCode = getInitialCode(language);
        inputStore.set(inputCode);
      }

      try {
        const result = await minifier.minifyCode(inputCode);
        triggerFlash();
        inputStore.set(result);
        showFeedback(minifyButton, minifyOriginal, "MINIFIED");
      } catch (error) {
        console.error("Minify Error:", error);
      }
    });
  }

  const copyButton = $("copy") as HTMLButtonElement;
  copyButton.addEventListener("click", () => {
    navigator.clipboard.writeText(inputStore.get());
    // Visual feedback for copy icon could go here
    copyButton.classList.add("bg-accent");
    setTimeout(() => copyButton.classList.remove("bg-accent"), 500);
  });
});
</script>
