---
import { getFormatter, getMinifier } from "@/handlers";
import Copy from "@/icons/copy.astro";
import Format from "@/icons/format.astro";
import Minify from "@/icons/minify.astro";
import { getInitialCode } from "@/lib/initialCode";
import { scope } from "simple:scope";
import Button from "../ui/button.astro";
import MonacoPlayground from "./MonacoPlayground.astro";

interface Props {
  minifier: boolean;
  language: string;
}

const { language, minifier } = Astro.props;

// Get the correct initial code for the current language
const initialCode = getInitialCode(language);
---

<RootElement>
  <div
    class="flex flex-col items-center justify-center mt-20 bg-background p-4 sm:p-6"
    data-language={language}
    data-target="root"
    id="formatter"
  >
    <div class="w-2/3 bg-card p-4 sm:p-6 rounded-lg shadow-lg">
      <div class="grid grid-cols-1 gap-6">
        <div class="relative">
          <MonacoPlayground inputCode={initialCode} language={language} />
        </div>
      </div>
      <div class="flex flex-col sm:flex-row justify-center mt-6 gap-4">
        <Button
          size="lg"
          target={scope("format")}
          class="flex items-center gap-2"
        >
          <Format class="w-4 h-4 mr-2" /> Format</Button>
        {minifier && (
          <Button
            size="lg"
            target={scope("minify")}
            class="flex items-center gap-2"
          >
            {" "} <Minify class="w-4 h-4 mr-2" /> Minify
          </Button>
        )}
        <Button
          size="lg"
          target={scope("copy")}
          class="flex items-center gap-2"
        >
          <Copy class="w-4 h-4 mr-2" /> Copy</Button>
      </div>
    </div>
  </div>
</RootElement>

<script>
import { getFormatter, getMinifier } from "@/handlers";
import { getInitialCode } from "@/lib/initialCode";

RootElement.ready(async ($) => {
  const divElement = $("root");
  const language = divElement.dataset.language!;

  const formatter = await getFormatter(language);
  const minifier = await getMinifier(language);

  // Function to get current content from Monaco editor using the proper workspace API
  async function getCurrentMonacoContent(): Promise<string> {
    const playground = document.getElementById("monaco-playground");

    if (!playground) {
      console.error("Monaco playground element not found");
      return getInitialCode(language);
    }

    try {
      // Use the proper workspace API to get current content
      const content = await window.MonacoPlayground.getCurrentContent(
        playground,
      );
      return content || getInitialCode(language);
    } catch (error) {
      console.error("Failed to get current Monaco content:", error);
      return getInitialCode(language);
    }
  }

  const trackEvent = (eventName: string, eventLabel: string) => {
    try {
      gtag("event", eventName, {
        event_category: "Button",
        event_label: eventLabel,
        value: language,
      });
    } catch (err) {
      console.error(
        `Error sending ${eventName} event to Google Analytics:`,
        err,
      );
    }
  };

  const showTickAnimation = (button: HTMLButtonElement, text: string) => {
    const originalIcon = button.innerHTML;
    button.innerHTML =
      "<svg class=\"w-4 h-4 mr-2\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 24 24\" stroke=\"currentColor\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\" /></svg> "
      + text;
    setTimeout(() => {
      button.innerHTML = originalIcon;
    }, 2000);
  };

  const formatButton = $("format") as HTMLButtonElement;
  formatButton.addEventListener("click", async () => {
    try {
      // Get current content directly from Monaco editor
      const inputCode = await getCurrentMonacoContent();

      // Final validation - ensure we have a non-empty string
      if (!inputCode || inputCode.trim() === "") {
        console.error("No valid input code available for formatting");
        alert("No code to format. Please enter some code first.");
        return;
      }

      console.log("Formatting:", inputCode.substring(0, 100) + "...");
      const formatted = await formatter.formatCode(inputCode);
      showTickAnimation(formatButton, "Formatted");

      // Update the Monaco editor using the workspace API
      try {
        const playground = document.getElementById("monaco-playground");
        if (playground) {
          await window.MonacoPlayground.updateContent(playground, formatted);
          console.log("Updated Monaco editor via workspace API");
        } else {
          console.error("Monaco playground element not found");
        }
      } catch (error) {
        console.error("Failed to update Monaco editor via workspace:", error);
        alert("Failed to update editor with formatted code.");
      }
    } catch (error) {
      console.error("Invalid code:", error);
      alert("Invalid code. Please check your syntax and try again.");
    }

    trackEvent(`Format ${language} Click`, "click");
  });

  if (minifier) {
    const minifyButton = $("minify") as HTMLButtonElement;
    minifyButton.addEventListener("click", async () => {
      try {
        // Get current content directly from Monaco editor
        const inputCode = await getCurrentMonacoContent();

        // Final validation - ensure we have a non-empty string
        if (!inputCode || inputCode.trim() === "") {
          console.error("No valid input code available for minifying");
          alert("No code to minify. Please enter some code first.");
          return;
        }

        console.log("Minifying:", inputCode.substring(0, 100) + "...");
        const minified = await minifier.minifyCode(inputCode);
        showTickAnimation(minifyButton, "Minified");

        // Update the Monaco editor using the workspace API
        try {
          const playground = document.getElementById("monaco-playground");
          if (playground) {
            await window.MonacoPlayground.updateContent(playground, minified);
            console.log(
              "Updated Monaco editor with minified content via workspace API",
            );
          } else {
            console.error("Monaco playground element not found for minify");
          }
        } catch (error) {
          console.error(
            "Failed to update Monaco editor via workspace for minify:",
            error,
          );
          alert("Failed to update editor with minified code.");
        }
      } catch (error) {
        console.error("Invalid code:", error);
        alert("Invalid code. Please check your syntax and try again.");
      }

      trackEvent(`Minify ${language} Click`, "click");
    });
  }

  const copyButton = $("copy") as HTMLButtonElement;
  copyButton.addEventListener("click", async () => {
    try {
      // Get current content directly from Monaco editor
      const contentToCopy = await getCurrentMonacoContent();
      await navigator.clipboard.writeText(contentToCopy);
      showTickAnimation(copyButton, "Copied");
      trackEvent(`Copy ${language} Click`, "click");
    } catch (error) {
      console.error("Failed to copy content:", error);
      alert("Failed to copy content to clipboard.");
    }
  });
});
</script>
