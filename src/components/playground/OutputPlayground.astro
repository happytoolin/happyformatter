---
import { scope } from "simple:scope";
import Textarea from "../ui/textarea.astro";
const { formattedJSON } = Astro.props as { formattedJSON: string };
---

<RootElement>
  <div
    class="language-ts vp-adaptive-theme mini-playground transition-none"
    style="color-scheme: inherit;"
  >
    <div class="relative mt-10 min-h-[400px] max-h-[600px] overflow-auto">
      <div
        class="block max-h-[600px] overflow-auto min-h-[400px]"
        data-target="highlight"
        id="highlightOutput"
      >
      </div>
      <Textarea
        class="whitespace-pre overflow-auto w-full h-full font-mono bg-transparent absolute inset-0 py-5 px-6 text-transparent caret-gray-600 tab-4 resize-none z-10 max-h-[600px] min-h-[400px]"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        target={scope("textarea")}
        spellcheck="false"
        readonly
        data-initial={formattedJSON}
      />
    </div>
  </div>
</RootElement>
<script>
  import { highlightJson, initializeHighlighter } from "@/lib/highlighter";
  import { formattedJSONStore } from "./store";

  function syncScroll(textArea: HTMLElement, highlightDiv: HTMLElement): void {
    const preElement = highlightDiv.querySelector("pre");

    if (!preElement) {
      console.error("No pre element found");
      return;
    }

    textArea.addEventListener("scroll", () => {
      preElement.scrollTop = textArea.scrollTop;
      preElement.scrollLeft = textArea.scrollLeft;

      highlightDiv.scrollTop = textArea.scrollTop;
      highlightDiv.scrollLeft = textArea.scrollLeft;
    });
  }

  RootElement.ready(async ($: any) => {
    const highlightDiv = $("highlight") as HTMLDivElement;
    const textArea = $("textarea") as HTMLTextAreaElement;

    try {
      const highlighter = await initializeHighlighter();

      formattedJSONStore.subscribe((formattedJSON: string) => {
        textArea.value = formattedJSON;
        const highlightedCode = highlightJson(formattedJSON, highlighter);
        highlightDiv.innerHTML = highlightedCode;
        syncScroll(textArea, highlightDiv);
      });
    } catch (error) {
      console.error("Initialization failed:", error);
    }
  });
</script>
